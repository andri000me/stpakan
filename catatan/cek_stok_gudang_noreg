declare @p_kode_farm varchar(2) = 'CJ'
	declare @maksimal_pallet varchar(50) = (
		select min(no_pallet) from MOVEMENT_D md
                       join KANDANG_SIKLUS ks
                        on ks.NO_REG = md.keterangan2 and ks.status_siklus = 'O' and ks.KODE_FARM = md.KODE_FARM
                       where md.keterangan1 = 'PUT' and md.KODE_FARM = @p_kode_farm
	)
<<<<<<< HEAD
    declare @p_flok varchar(2) = '4'

select distinct
			m.KODE_FARM
			, m.NO_KAVLING
			, m.NO_PALLET
			, m.KODE_BARANG
			, m.JENIS_KELAMIN
			, m.JML_ON_HAND
			, m.JML_AVAILABLE
			, m.BERAT_available
			, m.JML_ON_PICK
			, m.STATUS_STOK
			, m.KETERANGAN1
			, cast(m.PUT_DATE as date) PUT_DATE
			, m.KODE_PALLET
			, mk.LAYOUT_POSISI
			, mk.NO_BARIS
			, mk.NO_POSISI
			, mk.NO_KOLOM
			
		from KANDANG_SIKLUS ks
		join MOVEMENT m
			on m.KODE_FARM = ks.KODE_FARM
			and m.KETERANGAN1 = ks.FLOK_BDY
			and m.STATUS_STOK = 'NM'
			and m.JML_AVAILABLE > 0
			and m.NO_PALLET >= @maksimal_pallet
		join M_KAVLING mk
			on mk.KODE_FARM = m.KODE_FARM
			and mk.NO_KAVLING = m.NO_KAVLING
        where ks.FLOK_BDY = @p_flok    


/*
        EXEC GENERATE_PICKING_LIST_V2
               'CJ',
               '4',
               '',
               '',
               '2019-05-14',
               'PG0088'
*/			   
=======

select * from (
	select
		md_put.NO_REG
		, md_put.KODE_BARANG		
		, md_put.JML_PUTAWAY-isnull(md_pick.JML_PICK,0) JML_AVAILABLE
	from (
		select
			KETERANGAN2 NO_REG
			, KODE_BARANG
			, KODE_FARM
			, sum(JML_PUTAWAY) JML_PUTAWAY
		from MOVEMENT_D
		where KETERANGAN2 in (
			select
				NO_REG
			from kandang_siklus where status_siklus = 'O' and kode_farm = @p_kode_farm
			group by NO_REG
		)
		and STATUS_STOK = 'NM'
		and KETERANGAN1 = 'PUT'
		and NO_PALLET >= @maksimal_pallet
		group by
			KETERANGAN2
			, KODE_BARANG
			, KODE_FARM
	) md_put
	left join (
		select
			KETERANGAN2 NO_REG
			, KODE_BARANG
			, KODE_FARM
			, sum(JML_PICK) JML_PICK
		from MOVEMENT_D
		where KETERANGAN2 in (
			select
				NO_REG
			from kandang_siklus where status_siklus = 'O' and kode_farm = @p_kode_farm
			group by NO_REG
		)
		and STATUS_STOK = 'NM'
		and KETERANGAN1 = 'PICK'
		and NO_PALLET >= @maksimal_pallet
		group by
			KETERANGAN2
			, KODE_BARANG
			, KODE_FARM
	) md_pick
		on md_put.NO_REG = md_pick.NO_REG
		and md_put.KODE_BARANG = md_pick.KODE_BARANG
		and md_put.KODE_FARM = md_pick.KODE_FARM
)x where x.jml_available > 0 order by x.no_reg
>>>>>>> 53ac33e8886f01e73c357c79450caa9cbb1d4526
