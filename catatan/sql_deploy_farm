CREATE TABLE dbo.RETUR_FARM
	(
	NO_RETUR        VARCHAR (20) NOT NULL,
	FARM_ASAL VARCHAR (5) NOT NULL,
	FARM_TUJUAN VARCHAR (5) NOT NULL,
	TGL_KIRIM DATE NOT NULL,
	LAMPIRAN VARCHAR(MAX) NULL,
	NO_REFERENSI VARCHAR(20),
	STATUS VARCHAR(3) NOT NULL,
	NOPOL varchar(20) null,
	SOPIR varchar(50) null,
	PRIMARY KEY (NO_RETUR),
	CONSTRAINT FK_RETUR_FARM_ASAL FOREIGN KEY (FARM_ASAL) REFERENCES dbo.M_FARM (KODE_FARM),
	CONSTRAINT FK_RETUR_FARM_TUJUAN FOREIGN KEY (FARM_TUJUAN) REFERENCES dbo.M_FARM (KODE_FARM)
	)
GO
CREATE TABLE dbo.RETUR_FARM_D
	(
	NO_RETUR   VARCHAR (20) NOT NULL,
	KODE_PAKAN VARCHAR(15) NOT NULL,
	JUMLAH INT NOT NULL,
	PRIMARY KEY (NO_RETUR,KODE_PAKAN),
	CONSTRAINT FK_RETUR_FARM_D_KODE_PAKAN FOREIGN KEY (KODE_PAKAN) REFERENCES dbo.M_BARANG (KODE_BARANG),
	CONSTRAINT FK_RETUR_FARM_D_NO_RETUR FOREIGN KEY (NO_RETUR) REFERENCES dbo.RETUR_FARM (NO_RETUR)
	)
GO

CREATE TABLE dbo.LOG_RETUR_FARM
	(
	NO_RETUR   VARCHAR (20) NOT NULL,
	NO_URUT INT NOT NULL,
	STATUS VARCHAR(2) NOT NULL,
	USER_BUAT VARCHAR(15),
	TGL_BUAT DATETIME DEFAULT GETDATE() NOT NULL,
	KETERANGAN VARCHAR(150),
	PRIMARY KEY (NO_RETUR,NO_URUT),	
	CONSTRAINT FK_LOG_RETUR_FARM_NO_RETUR FOREIGN KEY (NO_RETUR) REFERENCES dbo.RETUR_FARM (NO_RETUR)
	)
GO

INSERT INTO dbo.SYS_MENU (SEQ_NO, TITLE, VALUE, LINK, REMARK, PARENT_ID)
VALUES (18, 'Retur Pakan Farm', 'Retur Pakan Farm', 'rekap_retur_pakan/retur_pakan_farm', NULL, 3)

INSERT INTO dbo.SYS_MENU (SEQ_NO, TITLE, VALUE, LINK, REMARK, PARENT_ID)
VALUES (13, 'Laporan BAPD', 'Laporan BAPD', 'report/laporan_bapd', NULL, 37)
GO

INSERT INTO dbo.SYS_MENU (SEQ_NO, TITLE, VALUE, LINK, REMARK, PARENT_ID)
VALUES (13, 'Laporan Kontrol Stok Pakan', 'Laporan Kontrol Stok Pakan', 'report/kontrol_stok_pakan/index', NULL, 37)
GO

/* alter tabel untuk Penerimaan pakan dari FM */
ALTER TABLE PENERIMAAN ADD ALASAN VARCHAR(200)

CREATE TABLE dbo.Verifikasi_DO_Pakan
	(
	KODE_FARM       VARCHAR (5) NOT NULL,
	NOPOL           VARCHAR (15) NOT NULL,
	NO_DO           VARCHAR (20) NOT NULL,
	TGL_DO          DATE NULL,
	NAMA_SOPIR      VARCHAR (50) NOT NULL,
	USER_VERIFIKASI VARCHAR (15) NOT NULL,
	TGL_VERIFIKASI  DATETIME NOT NULL,
	ASAL            VARCHAR (2) NOT NULL,
	PHOTO 			VARCHAR(100) NULL,
	CONSTRAINT uq_Verifikasi_DO_Pakan UNIQUE (NO_DO),
	CONSTRAINT FK_DO_REF_7602_M_FARM_Verifikasi_DO_Pakan FOREIGN KEY (KODE_FARM) REFERENCES dbo.M_FARM (KODE_FARM)
	)
GO

CREATE INDEX Verifikasi_DO_Pakan_idx
	ON dbo.Verifikasi_DO_Pakan (KODE_FARM, NOPOL, NO_DO)
GO


/* hapus kolom ID supaya gak auto increment */
alter table sys_config_general drop column ID
/*penambahan kolom kode_siklus*/
ALTER TABLE sales_order ADD kode_siklus int
ALTER TABLE sales_order ADD no_ref VARCHAR(20)

/* untuk rhk */
alter table rhk_lain2 alter column attachment varchar(200)

/* buat table sales_order di farm */
CREATE TABLE dbo.sales_order
	(
	no_so           VARCHAR (20) NOT NULL,
	tgl_so          DATE CONSTRAINT DF__sales_ord__tgl_s__62307D25 DEFAULT (getdate()) NULL,
	no_do           VARCHAR (20) NULL,
	kode_farm       VARCHAR (10) NOT NULL,
	kode_pelanggan  VARCHAR (10) NOT NULL,
	alamat          VARCHAR (200) NOT NULL,
	no_telp         VARCHAR (15) NOT NULL,
	term_pembayaran INT NOT NULL,
	jumlah_total    INT CONSTRAINT DF__sales_ord__jumla__6324A15E DEFAULT ((0)) NULL,
	harga_total     NUMERIC (12, 2) CONSTRAINT DF__sales_ord__harga__6418C597 DEFAULT ((0)) NULL,
	status_order    VARCHAR (2) CONSTRAINT DF_sales_order_status_order DEFAULT ('N') NULL,
	kode_siklus     INT NULL,
	no_ref          VARCHAR (20) NULL,
	CONSTRAINT PK__sales_or__E2D4559D0AE89A59 PRIMARY KEY (no_so)
	)
GO


CREATE TABLE dbo.RHK_CETAK
	(
	NO_REG        VARCHAR (20) NOT NULL,
	TGL_TRANSAKSI DATE NOT NULL,
	USER_CETAK    VARCHAR (10) NOT NULL,
	USER_LOGIN    VARCHAR (10) NOT NULL,
	TGL_CETAK     DATETIME NOT NULL,
	BARCODE       VARCHAR (15) NULL,
	CONSTRAINT PK_RHK_CETAK PRIMARY KEY (NO_REG, TGL_TRANSAKSI),
	CONSTRAINT RHK_CETAK_fk FOREIGN KEY (USER_CETAK) REFERENCES dbo.M_PEGAWAI (KODE_PEGAWAI) ON DELETE CASCADE,
	CONSTRAINT RHK_CETAK_fk2 FOREIGN KEY (USER_LOGIN) REFERENCES dbo.M_PEGAWAI (KODE_PEGAWAI)
	)
GO

IF OBJECT_ID ('dbo.rhk_rekomendasi_pakan') IS NOT NULL
	DROP TABLE dbo.rhk_rekomendasi_pakan
GO

CREATE TABLE dbo.rhk_rekomendasi_pakan
	(
	NO_REG          VARCHAR (20) NOT NULL,
	TGL_KEBUTUHAN   DATE NOT NULL,
	KODE_BARANG     VARCHAR (15) NOT NULL,
	JML_REKOMENDASI INT NOT NULL,
	JML_PERMINTAAN  INT NOT NULL,
	tgl_transaksi   DATE NULL,
	UNIQUE (NO_REG, TGL_KEBUTUHAN, KODE_BARANG)
	)
GO

alter table m_ploting_pelaksana add TGL_REVIEW datetime null
alter table m_ploting_pelaksana add TGL_ACK datetime null
alter table m_ploting_pelaksana add USER_REVIEW varchar(10) null
alter table m_ploting_pelaksana add USER_ACK varchar(10) null
alter table m_ploting_pelaksana add STATUS varchar(2) default('N')

jangan lupa buat folder rhk/scanning dalam folder file_upload dan set permissionnya writable

CREATE TABLE dbo.BAP_DOC_SJ
	(
	NO_REG           VARCHAR (20) NOT NULL,
	NO_SJ            VARCHAR (30) NOT NULL,
	KODE_HATCHERY    VARCHAR (10) NOT NULL,
	TGL_TERIMA       DATETIME NOT NULL,
	TGL_GENERATE     DATETIME NOT NULL,
	NOPOL_QRCODE     VARCHAR (15) NOT NULL,
	NOPOL_SCAN       VARCHAR (15) NOT NULL,
	KETERANGAN_NOPOL VARCHAR (50) NULL,
	JML_BOX          INT NOT NULL,
	JML_EKOR         INT NOT NULL,
	SOPIR            VARCHAR (30) NOT NULL,
	FOTO             VARCHAR (50) NULL,
	USER_BUAT 		 VARCHAR (10) NULL
	CONSTRAINT PK_BAP_DOC_SJ PRIMARY KEY (NO_REG, NO_SJ),
	CONSTRAINT BAP_DOC_SJ_fk FOREIGN KEY (KODE_HATCHERY) REFERENCES dbo.M_HATCHERY (KODE_HATCHERY),
	CONSTRAINT BAP_DOC_SJ_fk2 FOREIGN KEY (NO_REG) REFERENCES dbo.KANDANG_SIKLUS (NO_REG)
)



INSERT INTO dbo.SYS_MENU (SEQ_NO, TITLE, VALUE, LINK, REMARK, PARENT_ID)
VALUES (13, 'Import Kode Box BAPD', 'Import Kode Box BAPD', 'penerimaan_docin/import_box/index', NULL, 4)


IF OBJECT_ID ('dbo.DO_DRAFT') IS NOT NULL
	DROP TABLE dbo.DO_DRAFT
GO

CREATE TABLE dbo.DO_DRAFT
	(
	NO_DO          VARCHAR (20) NOT NULL,
	NO_OP          VARCHAR (20) NULL,
	TGL_KIRIM      DATE NULL,
	NO_URUT        INT NULL,
	KODE_FARM      VARCHAR (5) NULL,
	TGL_DO         DATE NULL,
	STATUS_DO      CHAR (1) NULL,
	TGL_BUAT       DATETIME DEFAULT (getdate()) NULL,
	TGL_UBAH       DATETIME DEFAULT (getdate()) NULL,
	USER_BUAT      VARCHAR (15) NULL,
	USER_UBAH      VARCHAR (15) NULL,
	TGL_VERIFIKASI DATETIME NULL,
	NO_DO_AWAL     VARCHAR (20) NULL,
	CONSTRAINT PK_DO_DO_DRAFT PRIMARY KEY (NO_DO),
	CONSTRAINT FK_DO_REF_7602_M_FARM_DO_DRAFT FOREIGN KEY (KODE_FARM) REFERENCES dbo.M_FARM (KODE_FARM)
	)
GO

IF OBJECT_ID ('dbo.DO_DRAFT_D') IS NOT NULL
	DROP TABLE dbo.DO_DRAFT_D
GO

CREATE TABLE dbo.DO_DRAFT_D
	(
	KODE_FARM   VARCHAR (5) NOT NULL,
	NO_DO       VARCHAR (20) NOT NULL,
	NO_OP       VARCHAR (20) NOT NULL,
	KODE_BARANG VARCHAR (15) NOT NULL,
	JML_MUAT    INT NULL,
	CONSTRAINT PK_DO_DRAFT_D PRIMARY KEY (NO_DO, KODE_BARANG),
	CONSTRAINT FK_DO_DRAFT_D_REF_5337_M_BARANG FOREIGN KEY (KODE_BARANG) REFERENCES dbo.M_BARANG (KODE_BARANG),
	CONSTRAINT FK_DO_DRAFT_D_REF_7606_DO FOREIGN KEY (NO_DO) REFERENCES dbo.DO (NO_DO)
	)
GO

IF OBJECT_ID ('dbo.DO_DRAFT_E') IS NOT NULL
	DROP TABLE dbo.DO_DRAFT_E
GO

CREATE TABLE dbo.DO_DRAFT_E
	(
	NO_DO         VARCHAR (20) NOT NULL,
	KODE_BARANG   VARCHAR (15) NOT NULL,
	NO_REG        VARCHAR (20) NOT NULL,
	JENIS_KELAMIN CHAR (1) NOT NULL,
	JML_MUAT      INT NULL,
	CONSTRAINT PK_DO_DRAFT_E PRIMARY KEY (NO_DO, KODE_BARANG, NO_REG, JENIS_KELAMIN),
	CONSTRAINT FK_DO_DRAFT_E_REF_28403_DO_D FOREIGN KEY (NO_DO, KODE_BARANG) REFERENCES dbo.DO_D (NO_DO, KODE_BARANG),
	CONSTRAINT FK_DO_DRAFT_E_REF_28410_KANDANG_ FOREIGN KEY (NO_REG) REFERENCES dbo.KANDANG_SIKLUS (NO_REG)
	)
GO

ALTER TABLE M_EKPEDISI_VEHICLE_NEW ADD MIN_RIT INT

CREATE TABLE dbo.LOG_PLOTING_DO
	(
	NO_DO     VARCHAR (20) NOT NULL,
	NO_URUT    INT NOT NULL,
	STATUS     VARCHAR (2) NOT NULL,
	KETERANGAN VARCHAR (150) NULL,
	TGL_BUAT   DATETIME NOT NULL,
	USER_BUAT  VARCHAR (15) NOT NULL,
	PRIMARY KEY (NO_DO, NO_URUT),
	CONSTRAINT LOG_PLOTING_DO_DO FOREIGN KEY (NO_DO) REFERENCES dbo.DO (NO_DO)
	)

INSERT INTO dbo.SYS_MENU (SEQ_NO, TITLE, VALUE, LINK, REMARK, PARENT_ID)
VALUES (9, 'Approve DO', 'Approve DO', 'permintaan_pakan_V2/pembelian_pakan/approve', '', 2)

UPDATE REALISASI_PANEN_DO SET NOPOL = REPLACE(nopol, ' ', '');
ALTER TABLE REALISASI_PANEN_DO ADD ID_SOPIR VARCHAR(10);
ALTER TABLE REALISASI_PANEN_DO ADD SOPIR VARCHAR(25);
ALTER TABLE REALISASI_PANEN_DO ADD NIK_TIMPANEN INT;
ALTER TABLE REALISASI_PANEN_DO ADD MULAI_PANEN DATETIME;
ALTER TABLE REALISASI_PANEN_DO ADD SELESAI_PANEN DATETIME;


CREATE TABLE dbo.Verifikasi_DO_Panen
(
	KODE_FARM       VARCHAR (5) NOT NULL,
	NOPOL           VARCHAR (15) NOT NULL,
	NO_DO           VARCHAR (20) NOT NULL,
	NO_SJ          VARCHAR (20) NULL,
	NAMA_SOPIR      VARCHAR (50) NOT NULL,
	USER_VERIFIKASI VARCHAR (15) NOT NULL,
	TGL_VERIFIKASI  DATETIME NULL,
	USER_VERIFIKASI_SJ VARCHAR (15) NULL,
	TGL_VERIFIKASI_SJ  DATETIME NULL,
	PHOTO 			VARCHAR(100) NULL,
	CONSTRAINT uq_Verifikasi_DO_Panen UNIQUE (NO_DO),
	CONSTRAINT FK_DO_REF_7608_M_FARM_Verifikasi_DO_Panen FOREIGN KEY (KODE_FARM) REFERENCES dbo.M_FARM (KODE_FARM)
)

ALTER TABLE Verifikasi_DO_Panen ALTER column TGL_VERIFIKASI DATETIME NULL

/* Untuk mapping kode_pegawai stpakan dan user id di attendance */
CREATE TABLE PEGAWAI_ATTENDANCE(
	KODE_PEGAWAI VARCHAR(10) NOT NULL,
	BADGE_NUMBER VARCHAR(24) NOT NULL,
	PRIMARY KEY (KODE_PEGAWAI)
)
ALTER TABLE PEGAWAI_ATTENDANCE ADD CONSTRAINT UQ_PEGAWAI_ATTENDANCE UNIQUE (BADGE_NUMBER)
/* menambahkan column untuk CHECKINOUT, antisipasi kemungkinan jamnya beda antara mesin finger dan server stpakan*/ 
ALTER TABLE attendance.dbo.CHECKINOUT ADD CREATED_AT DATETIME DEFAULT(getdate())

/* menambahkan menu PP untuk koordinator pengawas */
INSERT INTO dbo.SYS_USER_MENU (GRUP_PEGAWAI, MENU_ID)
VALUES ('KPPB', 2)
GO

INSERT INTO dbo.SYS_USER_MENU (GRUP_PEGAWAI, MENU_ID)
VALUES ('KPPB', 8)
GO

/* untuk mapping pegawai attendance*/
INSERT INTO dbo.SYS_MENU (SEQ_NO, TITLE, VALUE, LINK, REMARK, PARENT_ID)
VALUES (21, 'Mapping Attendance', 'Mapping Attendance', 'master/pegawai_attendance', NULL, 19)